<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recollection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"></script>
    <style>
        :root {
            /* Apple-inspired color palette - refined */
            --primary-color: #0A84FF;
            --primary-dark: #0071E3;
            --primary-light: #64D2FF;
            --secondary-color: #30D158;
            --accent-color: #FF375F;
            --warning-color: #FF9F0A;
            --danger-color: #FF453A;
            --success-color: #34C759;
            --neutral-color: #8E8E93;
            
            /* Base colors - refined Apple look */
            --background-color: #F5F5F7;
            --card-color: #FFFFFF;
            --text-color: #1D1D1F;
            --text-secondary: #86868B;
            --border-color: #D2D2D7;
            --subtle-color: #F2F2F7;
            
            /* Dark mode colors - refined */
            --dark-background: #000000;
            --dark-card: #1C1C1E;
            --dark-elevated: #2C2C2E;
            --dark-text: #F5F5F7;
            --dark-text-secondary: #98989D;
            --dark-border: #38383A;
            --dark-subtle: #242426;
            
            /* UI elements - refined for Apple aesthetic */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.03);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 8px 20px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 12px 30px rgba(0, 0, 0, 0.12);
            
            --radius-sm: 8px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            
            --font-sans: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --spring-transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .dark-mode {
            --background-color: var(--dark-background);
            --card-color: var(--dark-card);
            --text-color: var(--dark-text);
            --text-secondary: var(--dark-text-secondary);
            --border-color: var(--dark-border);
            --subtle-color: var(--dark-subtle);
            background-image: linear-gradient(180deg, var(--dark-background) 0%, var(--dark-background) 85%, rgba(40, 40, 45, 0.3) 100%);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-sans);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
            background-image: linear-gradient(180deg, var(--background-color) 0%, var(--background-color) 85%, rgba(220, 220, 225, 0.3) 100%);
        }
        
        .container {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
            padding: 24px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 0;
            margin-bottom: 32px;
            position: relative;
        }
        
        .app-title {
            display: flex;
            align-items: center;
        }
        
        .app-title h1 {
            color: var(--text-color);
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.05em;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        
        .app-title .logo {
            margin-right: 12px;
            font-size: 20px;
            color: white;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            height: 44px;
            width: 44px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        .app-title .logo::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
            border-radius: var(--radius-sm);
        }
        
        .header-actions {
            display: flex;
            gap: 16px;
        }
        
        .dark-mode-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-color);
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dark-mode-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
        }
        
        .dark-mode .dark-mode-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .tab-container {
            display: flex;
            background-color: var(--subtle-color);
            border-radius: var(--radius-xl);
            padding: 5px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 16px;
            z-index: 10;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        
        .dark-mode .tab-container {
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .tab {
            padding: 10px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: var(--radius-lg);
            transition: var(--spring-transition);
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            margin: 0 2px;
            box-shadow: none;
        }
        
        .tab i {
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: var(--primary-color);
            background-color: rgba(0, 122, 255, 0.05);
        }
        
        .tab::after {
            display: none;
        }
        
        .tab.active {
            background-color: var(--card-color);
            color: var(--primary-color);
            box-shadow: var(--shadow-sm);
            transform: scale(1.02);
        }
        
        .tab.active i {
            transform: scale(1.1);
        }
        
        .tab-content {
            display: none;
            background-color: var(--card-color);
            border-radius: var(--radius-lg);
            padding: 32px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 32px;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid rgba(0, 0, 0, 0.03);
            transform-origin: center top;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .dark-mode .tab-content {
            border: 1px solid rgba(255, 255, 255, 0.03);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        h2 {
            color: var(--text-color);
            margin-bottom: 24px;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: var(--primary-color);
        }
        
        h3 {
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        h3 i {
            color: var(--primary-color);
        }
        
        h2 {
            color: var(--text-color);
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        
        h3 {
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: -0.2px;
        }
        
        .card-creator {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 15px;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .input, 
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--card-color);
            color: var(--text-color);
            font-size: 15px;
            transition: var(--transition);
            appearance: none;
            -webkit-appearance: none;
        }
        
        .input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.5;
        }
        
        .input-hint {
            margin-top: 4px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
            letter-spacing: -0.01em;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            pointer-events: none;
        }
        
        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        button:active {
            transform: scale(0.97);
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
            transition: all 0.1s ease;
        }
        
        button.secondary {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
            border: 1px solid transparent;
        }
        
        .dark-mode button.secondary {
            background-color: rgba(255, 255, 255, 0.08);
            color: var(--dark-text);
        }
        
        button.secondary:hover {
            background-color: rgba(0, 0, 0, 0.08);
        }
        
        button.danger {
            background-color: var(--danger-color);
        }
        
        button.danger:hover {
            background-color: #FF1A1A;
        }
        
        button.success {
            background-color: var(--success-color);
        }
        
        button.success:hover {
            background-color: #27BB4E;
        }
        
        button.warning {
            background-color: var(--warning-color);
        }
        
        button.warning:hover {
            background-color: #E67E00;
        }
        
        button.text {
            background: none;
            color: var(--primary-color);
            padding: 8px 12px;
        }
        
        button.text:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }
        
        button.sm {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
        }
        
        .row {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
        }
        
        .col {
            flex: 1;
        }
        
        .deck-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }
        
        .deck-card {
            background-color: var(--card-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            transition: var(--spring-transition);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transform-origin: center;
        }
        
        .dark-mode .deck-card {
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .deck-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-lg);
            border-color: rgba(0, 122, 255, 0.3);
            z-index: 1;
        }
        
        .deck-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.07), 
                rgba(255, 255, 255, 0));
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            pointer-events: none;
        }
        
        .deck-color-tag {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        }
        
        .deck-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .deck-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
        }
        
        .deck-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .stat i {
            color: var(--primary-color);
            width: 16px;
            text-align: center;
        }
        
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .tag {
            background-color: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .deck-actions {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
        }
        
        .study-card-container {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        .flashcard {
            position: relative;
            perspective: 2000px;
            width: 100%;
            height: 400px;
            margin-bottom: 32px;
        }
        
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
        }
        
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: var(--radius-xl);
            padding: 32px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            overflow-y: auto;
            box-shadow: 
                inset 0 0 0 1px rgba(255, 255, 255, 0.1),
                0 0 0 1px rgba(0, 0, 0, 0.03);
        }
        
        .dark-mode .flashcard-front, .dark-mode .flashcard-back {
            box-shadow: 
                inset 0 0 0 1px rgba(255, 255, 255, 0.05),
                0 0 0 1px rgba(0, 0, 0, 0.2);
        }
        
        .flashcard-front::before, .flashcard-back::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.07), 
                rgba(255, 255, 255, 0));
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            pointer-events: none;
        }
        
        .flashcard-back {
            transform: rotateY(180deg);
        }
        
        .card-content {
            font-size: 24px;
            line-height: 1.5;
            max-width: 100%;
            word-break: break-word;
        }
        
        .card-meta {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
        }
        
        .card-number {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .card-actions {
            position: absolute;
            top: 16px;
            right: 16px;
        }
        
        .study-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 32px;
            flex-wrap: wrap;
        }
        
        .keyboard-shortcuts {
            margin-top: 32px;
            padding: 16px;
            background-color: var(--background-color);
            border-radius: var(--radius-md);
        }
        
        .shortcut-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .key {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-color);
            box-shadow: var(--shadow-sm);
        }
        
        .empty-state {
            text-align: center;
            padding: 64px 32px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--primary-color);
            width: 80px;
            height: 80px;
            background-color: rgba(0, 122, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }
        
        .empty-state-text {
            font-size: 20px;
            color: var(--text-color);
            margin-bottom: 24px;
            font-weight: 600;
        }
        
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 8px;
            gap: 8px;
            background-color: var(--card-color);
        }
        
        .tags-input:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }
        
        .tags-input input {
            flex: 1;
            min-width: 120px;
            border: none;
            outline: none;
            padding: 4px;
            font-size: 15px;
            background: transparent;
            color: var(--text-color);
        }
        
        .tag-item {
            display: flex;
            align-items: center;
            background-color: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 13px;
        }
        
        .tag-remove {
            cursor: pointer;
            margin-left: 6px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--primary-color);
        }
        
        .tag-remove:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .search-input {
            flex: 1;
            position: relative;
        }
        
        .search-input input {
            padding-left: 40px;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .filter-dropdown {
            position: relative;
        }
        
        .filter-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: var(--card-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 8px;
            min-width: 200px;
            z-index: 100;
            display: none;
            border: 1px solid var(--border-color);
        }
        
        .filter-menu.active {
            display: block;
            animation: fadeIn 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            font-size: 14px;
        }
        
        .filter-option:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }
        
        .filter-option.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 999px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 999px;
            transition: width 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--card-color);
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: translateY(30px) scale(0.95);
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode .modal-content {
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .modal.active .modal-content {
            transform: translateY(0) scale(1);
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.05), 
                rgba(255, 255, 255, 0));
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            pointer-events: none;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 18px;
        }
        
        .modal-close:hover {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--danger-color);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: var(--card-color);
            color: var(--text-color);
            border-radius: var(--radius-xl);
            padding: 16px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.12),
                0 0 0 1px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px) scale(0.95);
            opacity: 0;
            transition: 
                transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), 
                opacity 0.3s ease;
            z-index: 1000;
            max-width: 400px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            pointer-events: none;
        }
        
        .dark-mode .toast {
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        .toast.active {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        .toast-icon {
            font-size: 18px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: toast-icon-pulse 2s infinite;
        }
        
        @keyframes toast-icon-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .toast.success .toast-icon {
            color: white;
            background: linear-gradient(135deg, var(--success-color), #34c759);
        }
        
        .toast.error .toast-icon {
            color: white;
            background: linear-gradient(135deg, var(--danger-color), #ff453a);
        }
        
        .toast.info .toast-icon {
            color: white;
            background: linear-gradient(135deg, var(--primary-color), #0a84ff);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 15px;
        }
        
        .toast-message {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .toast-close {
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background-color: var(--card-color);
            border-radius: var(--radius-md);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-label i {
            color: var(--primary-color);
        }
        
        .chart-container {
            background-color: var(--card-color);
            border-radius: var(--radius-md);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
        }

        .card-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .card-list-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .card-list-item:hover {
            background-color: rgba(0, 122, 255, 0.05);
        }

        .card-list-item:last-child {
            border-bottom: none;
        }

        .card-question {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .card-answer {
            color: var(--text-secondary);
            font-size: 14px;
        }

        footer {
            text-align: center;
            padding: 32px;
            margin-top: auto;
            color: var(--text-secondary);
            font-size: 14px;
            border-top: 1px solid var(--border-color);
        }
        
        .cloze {
            padding: 4px 8px;
            background-color: rgba(10, 132, 255, 0.08);
            color: var(--primary-color);
            border-radius: 6px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(10, 132, 255, 0.2);
            display: inline-block;
            margin: 0 2px;
            position: relative;
        }
        
        .dark-mode .cloze {
            background-color: rgba(10, 132, 255, 0.15);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .cloze-revealed {
            padding: 4px 8px;
            background-color: rgba(48, 209, 88, 0.08);
            color: var(--success-color);
            border-radius: 6px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(48, 209, 88, 0.2);
            display: inline-block;
            margin: 0 2px;
            position: relative;
            animation: reveal-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .dark-mode .cloze-revealed {
            background-color: rgba(48, 209, 88, 0.15);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes reveal-pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .forecast-day {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .forecast-day:last-child {
            border-bottom: none;
        }
        
        .forecast-date {
            font-weight: 600;
        }
        
        .forecast-count {
            background-color: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
            border-radius: 999px;
            padding: 2px 10px;
            font-size: 14px;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .tab-container {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .tab {
                flex: auto;
                min-width: calc(50% - 6px);
            }
            
            .row {
                flex-direction: column;
            }
            
            .flashcard {
                height: 300px;
            }
            
            .deck-list {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                padding: 16px;
            }
            
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .study-controls {
                flex-direction: column;
            }
            
            .study-controls button {
                width: 100%;
            }
        }
        
        /* Reset button */
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .action-btn:hover {
            color: var(--primary-color);
            background-color: rgba(0, 122, 255, 0.1);
        }
        
        /* Type switch */
        .switch-container {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .switch-option {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background-color: var(--card-color);
            border: none;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            transition: var(--transition);
        }
        
        .switch-option.active {
            background-color: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
          <div class="app-title">
            <div class="logo">
                    <i class="fas fa-graduation-cap"></i>
              </div>
              <h1>Recollection&nbsp;</h1>
            </div>
            <div class="header-actions">
                <button class="dark-mode-toggle" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div class="tab-container">
            <button class="tab active" data-tab="create">
                <i class="fas fa-plus-circle"></i> Create
            </button>
            <button class="tab" data-tab="decks">
                <i class="fas fa-layer-group"></i> My Decks
            </button>
            <button class="tab" data-tab="study">
                <i class="fas fa-book-open"></i> Study
            </button>
            <button class="tab" data-tab="stats">
                <i class="fas fa-chart-bar"></i> Stats
            </button>
        </div>

        <div id="create" class="tab-content active">
            <h2><i class="fas fa-pen"></i> Create New Flashcards</h2>
            
            <div class="card-creator">
                <div class="row">
                    <div class="col form-group">
                        <label for="deck-name">Deck Name</label>
                        <div class="input-wrapper">
                            <input type="text" id="deck-name" class="input" placeholder="Enter deck name">
                        </div>
                    </div>
                    <div class="col form-group">
                        <label for="deck-tags">Tags</label>
                        <div class="tags-input" id="tags-container">
                            <input type="text" id="tag-input" placeholder="Add tags (press Enter)">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Card Type</label>
                    <div class="switch-container">
                        <button id="basic-card-type" class="switch-option active">
                            <i class="fas fa-file-alt"></i> Basic
                        </button>
                        <button id="cloze-card-type" class="switch-option">
                            <i class="fas fa-highlighter"></i> Cloze Deletion
                        </button>
                    </div>
                    <div class="input-hint">Basic cards have a question on front and answer on back. Cloze cards hide parts of text that you need to recall.</div>
                </div>
                
                <div class="form-group">
                    <label for="card-front">Front (Question)</label>
                    <textarea id="card-front" placeholder="Enter your question or prompt"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="card-back">Back (Answer)</label>
                    <textarea id="card-back" placeholder="Enter the answer or explanation"></textarea>
                </div>
                
                <div class="row">
                    <div class="col">
                        <button id="add-card">
                            <i class="fas fa-plus"></i> Add Card
                        </button>
                    </div>
                    <div class="col" style="text-align: right;">
                        <button id="clear-form" class="secondary">
                            <i class="fas fa-eraser"></i> Clear Form
                        </button>
                    </div>
                </div>
                
                <div class="row" style="margin-top: 1rem;">
                    <div class="col">
                        <h3><i class="fas fa-history"></i> Recently Added Cards</h3>
                        <div id="recent-cards" class="card-list">
                            <!-- Recent cards will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <div class="row" style="margin-top: 2rem;">
                    <div class="col">
                        <h3><i class="fas fa-exchange-alt"></i> Import/Export</h3>
                        <div class="btn-group">
                            <button id="export-deck">
                                <i class="fas fa-file-export"></i> Export Deck
                            </button>
                            <button id="import-deck" class="secondary">
                                <i class="fas fa-file-import"></i> Import Deck
                            </button>
                            <input type="file" id="import-file" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="decks" class="tab-content">
            <h2><i class="fas fa-layer-group"></i> My Decks</h2>
            <div class="search-bar">
                <div class="search-input">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="deck-search" class="input" placeholder="Search decks...">
                </div>
                <div class="filter-dropdown">
                    <button id="filter-btn" class="secondary">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                    <div class="filter-menu" id="filter-menu">
                        <div class="filter-option active">All Decks</div>
                        <div class="filter-option">Recently Studied</div>
                        <div class="filter-option">Most Cards</div>
                        <div class="filter-option">Due Cards</div>
                    </div>
                </div>
            </div>
            
            <div id="deck-list" class="deck-list">
                <!-- Decks will be inserted here -->
            </div>
            
            <div id="no-decks" class="empty-state" style="display: none;">
                <div class="empty-state-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="empty-state-text">You don't have any decks yet</div>
                <button id="create-first-deck">
                    <i class="fas fa-plus"></i> Create Your First Deck
                </button>
            </div>
        </div>

        <div id="study" class="tab-content">
            <div id="study-header">
                <h2 id="study-deck-name">Select a deck to study</h2>
                <div class="progress-bar">
                    <div id="study-progress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="study-stats" class="stats-container">
                    <div class="stat-card">
                        <div id="remaining-count" class="stat-value">0</div>
                        <div class="stat-label">
                            <i class="fas fa-hourglass-half"></i> Remaining
                        </div>
                    </div>
                    <div class="stat-card">
                        <div id="total-count" class="stat-value">0</div>
                        <div class="stat-label">
                            <i class="fas fa-layer-group"></i> Total Cards
                        </div>
                    </div>
                    <div class="stat-card">
                        <div id="session-time" class="stat-value">00:00</div>
                        <div class="stat-label">
                            <i class="fas fa-clock"></i> Session Time
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="study-card-container" class="study-card-container" style="display: none;">
                <div class="flashcard" id="flashcard">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <div class="card-meta">
                                <div class="card-number" id="card-number">Card 1/10</div>
                            </div>
                            <div class="card-actions">
                                <button class="action-btn" id="edit-current-card">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </div>
                            <div id="card-front-content" class="card-content"></div>
                        </div>
                        <div class="flashcard-back">
                            <div id="card-back-content" class="card-content"></div>
                        </div>
                    </div>
                </div>
                
                <div class="study-controls" id="flip-controls">
                    <button id="flip-card">
                        <i class="fas fa-sync-alt"></i> Show Answer (Space)
                    </button>
                </div>
                
                <div class="study-controls" id="rating-controls" style="display: none;">
                    <button class="danger" data-difficulty="again">
                        <i class="fas fa-redo"></i> Again (1)
                    </button>
                    <button class="warning" data-difficulty="hard">
                        <i class="fas fa-exclamation-circle"></i> Hard (2)
                    </button>
                    <button data-difficulty="good">
                        <i class="fas fa-check"></i> Good (3)
                    </button>
                    <button class="success" data-difficulty="easy">
                        <i class="fas fa-check-double"></i> Easy (4)
                    </button>
                </div>
                
                <div class="keyboard-shortcuts">
                    <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item">
                            <div class="key">Space</div>
                            <div>Flip Card</div>
                        </div>
                        <div class="shortcut-item">
                            <div class="key">1</div>
                            <div>Again</div>
                        </div>
                        <div class="shortcut-item">
                            <div class="key">2</div>
                            <div>Hard</div>
                        </div>
                        <div class="shortcut-item">
                            <div class="key">3</div>
                            <div>Good</div>
                        </div>
                        <div class="shortcut-item">
                            <div class="key">4</div>
                            <div>Easy</div>
                        </div>
                        <div class="shortcut-item">
                            <div class="key">E</div>
                            <div>Edit Card</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="deck-selection" class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-book-open"></i>
                </div>
                <div class="empty-state-text">Select a deck to start studying</div>
                <button id="show-deck-list">
                    <i class="fas fa-layer-group"></i> View My Decks
                </button>
            </div>
            
            <div id="session-complete" class="empty-state" style="display: none;">
                <div class="empty-state-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="empty-state-text">Session Complete!</div>
                <div style="margin-bottom: 1.5rem;">
                    <div>You've completed all due cards for now.</div>
                    <div id="session-summary"></div>
                </div>
                <div class="btn-group">
                    <button id="restart-session">
                        <i class="fas fa-redo-alt"></i> Restart Session
                    </button>
                    <button id="return-to-decks" class="secondary">
                        <i class="fas fa-layer-group"></i> Return to Decks
                    </button>
                </div>
            </div>
        </div>

        <div id="stats" class="tab-content">
            <h2><i class="fas fa-chart-bar"></i> Study Statistics</h2>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="total-cards-stat">0</div>
                    <div class="stat-label">
                        <i class="fas fa-clone"></i> Total Cards
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-decks-stat">0</div>
                    <div class="stat-label">
                        <i class="fas fa-layer-group"></i> Total Decks
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cards-studied-stat">0</div>
                    <div class="stat-label">
                        <i class="fas fa-check-circle"></i> Studied Today
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="streak-stat">0</div>
                    <div class="stat-label">
                        <i class="fas fa-fire"></i> Day Streak
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col">
                    <h3><i class="fas fa-calendar-alt"></i> Upcoming Reviews</h3>
                    <div id="forecast-container" class="chart-container" style="height: auto; padding: 0;">
                        <!-- Forecast data will be inserted here dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <div id="edit-card-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-pen"></i> Edit Card</h3>
                    <button class="modal-close" id="close-edit-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit-card-front">Front (Question)</label>
                        <textarea id="edit-card-front" placeholder="Enter your question or prompt"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-card-back">Back (Answer)</label>
                        <textarea id="edit-card-back" placeholder="Enter the answer or explanation"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="save-edit" class="success">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button id="cancel-edit" class="secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>

        <div id="reset-deck-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-redo-alt"></i> Reset Deck Progress</h3>
                    <button class="modal-close" id="close-reset-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to reset all progress for this deck? This will:</p>
                    <ul style="margin: 16px 0 16px 24px;">
                        <li>Reset all learning intervals</li>
                        <li>Mark all cards as new</li>
                        <li>Clear review history for this deck</li>
                    </ul>
                    <p>This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button id="confirm-reset" class="danger">
                        <i class="fas fa-redo-alt"></i> Reset Deck
                    </button>
                    <button id="cancel-reset" class="secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>

        <div id="toast" class="toast">
            <div class="toast-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">Success</div>
                <div class="toast-message">Card added successfully!</div>
            </div>
            <div class="toast-close">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>
    
    <footer>
        <div>Recollection © 2025 - Your Ultimate Flashcard Study System</div>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize state
            let decks = JSON.parse(localStorage.getItem('flashcards-decks')) || {};
            let currentStudyingDeck = null;
            let cardsToStudy = [];
            let currentCardIndex = 0;
            let studySessionStartTime = null;
            let sessionTimer = null;
            let editingCardId = null;
            let resettingDeckName = null;
            let isDarkMode = localStorage.getItem('dark-mode') === 'true';
            let currentTags = [];
            let cardType = 'basic'; // 'basic' or 'cloze'
            let statistics = JSON.parse(localStorage.getItem('flashcards-stats')) || {
                totalStudied: 0,
                streak: 0,
                lastStudyDate: null,
                dailyStats: {},
                cardsMastered: 0
            };
            
            // Fix for button interaction issues by using event delegation
            document.addEventListener('click', function(e) {
                // Find the closest button
                const button = e.target.closest('button');
                if (!button) return;
                
                // Check for specific buttons and trigger their handlers
                if (button.classList.contains('study-deck-btn')) {
                    const deckName = button.closest('.deck-card').querySelector('.deck-title').textContent;
                    startStudySession(deckName);
                    document.querySelector('[data-tab="study"]').click();
                } else if (button.classList.contains('reset-deck-btn')) {
                    const deckName = button.closest('.deck-card').querySelector('.deck-title').textContent;
                    resetDeck(deckName);
                } else if (button.classList.contains('delete-deck-btn')) {
                    const deckName = button.closest('.deck-card').querySelector('.deck-title').textContent;
                    if (confirm(`Are you sure you want to delete "${deckName}"? This cannot be undone.`)) {
                        delete decks[deckName];
                        saveDecks();
                        renderDeckList();
                        showToast('Success', `Deck "${deckName}" deleted`, 'info');
                    }
                }
            });
            
            // Set initial dark mode if needed
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // Initialize tabs
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Special actions for specific tabs
                    if (tabId === 'decks') {
                        renderDeckList();
                    } else if (tabId === 'stats') {
                        updateStatistics();
                    }
                });
            });

            // Dark mode toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                isDarkMode = !isDarkMode;
                document.body.classList.toggle('dark-mode');
                document.getElementById('theme-toggle').innerHTML = isDarkMode ? 
                    '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                localStorage.setItem('dark-mode', isDarkMode);
            });
            
            // Card type toggle
            document.getElementById('basic-card-type').addEventListener('click', function() {
                setCardType('basic');
            });
            
            document.getElementById('cloze-card-type').addEventListener('click', function() {
                setCardType('cloze');
            });
            
            function setCardType(type) {
                cardType = type;
                document.getElementById('basic-card-type').classList.toggle('active', type === 'basic');
                document.getElementById('cloze-card-type').classList.toggle('active', type === 'cloze');
                
                // Update placeholder text based on card type
                if (type === 'basic') {
                    document.getElementById('card-front').placeholder = 'Enter your question or prompt';
                    document.getElementById('card-back').placeholder = 'Enter the answer or explanation';
                } else {
                    document.getElementById('card-front').placeholder = 'Enter text with cloze deletions using {{...}} (e.g., The capital of France is {{Paris}})';
                    document.getElementById('card-back').placeholder = 'Enter additional information (optional)';
                }
            }
            
            // Tags input functionality
            const tagInput = document.getElementById('tag-input');
            const tagsContainer = document.getElementById('tags-container');
            
            tagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && this.value.trim() !== '') {
                    e.preventDefault();
                    addTag(this.value.trim());
                    this.value = '';
                }
            });
            
            function addTag(tagText) {
                // Don't add duplicate tags
                if (currentTags.includes(tagText)) return;
                
                const tag = document.createElement('div');
                tag.className = 'tag-item';
                tag.innerHTML = `
                    ${tagText}
                    <span class="tag-remove" data-tag="${tagText}"><i class="fas fa-times"></i></span>
                `;
                tagsContainer.insertBefore(tag, tagInput);
                currentTags.push(tagText);
                
                // Add event listener to remove tag
                tag.querySelector('.tag-remove').addEventListener('click', function() {
                    const tagToRemove = this.getAttribute('data-tag');
                    removeTag(tagToRemove);
                });
            }
            
            function removeTag(tagText) {
                const tagElements = document.querySelectorAll('.tag-item');
                tagElements.forEach(tag => {
                    if (tag.textContent.trim().replace('×', '') === tagText) {
                        tag.remove();
                    }
                });
                
                currentTags = currentTags.filter(tag => tag !== tagText);
            }
            
            function clearTags() {
                const tagElements = document.querySelectorAll('.tag-item');
                tagElements.forEach(tag => tag.remove());
                currentTags = [];
            }
            
            // Add card functionality
            const addCardButton = document.getElementById('add-card');
            const cardFrontInput = document.getElementById('card-front');
            const cardBackInput = document.getElementById('card-back');
            const deckNameInput = document.getElementById('deck-name');
            
            addCardButton.addEventListener('click', () => {
                let front = cardFrontInput.value.trim();
                let back = cardBackInput.value.trim();
                const deckName = deckNameInput.value.trim() || 'Default Deck';
                
                if (!front) {
                    showToast('Error', 'Front side cannot be empty', 'error');
                    return;
                }
                
                // Process cloze deletion cards
                if (cardType === 'cloze') {
                    // Validate cloze format
                    if (!front.includes('{{') || !front.includes('}}')) {
                        showToast('Error', 'Cloze cards must include text in {{...}} format', 'error');
                        return;
                    }
                }
                
                // Create deck if it doesn't exist
                if (!decks[deckName]) {
                    decks[deckName] = [];
                }
                
                // Add card to deck
                const newCard = {
                    id: generateId(),
                    front: front,
                    back: back,
                    tags: [...currentTags],
                    type: cardType,
                    lastReviewed: null,
                    interval: 1,
                    ease: 2.5,
                    status: 'new'
                };
                
                decks[deckName].push(newCard);
                
                // Save to localStorage
                saveDecks();
                
                // Update recent cards
                addToRecentCards(newCard, deckName);
                
                // Show toast notification
                showToast('Success', `Card added to "${deckName}"`, 'success');
                
                // Clear inputs but keep deck name and tags
                cardFrontInput.value = '';
                cardBackInput.value = '';
                cardFrontInput.focus();
            });
            
            // Clear form
            document.getElementById('clear-form').addEventListener('click', () => {
                deckNameInput.value = '';
                cardFrontInput.value = '';
                cardBackInput.value = '';
                clearTags();
                setCardType('basic');
            });
            
            // Function to add card to recent cards list
            function addToRecentCards(card, deckName) {
                const recentCardsList = document.getElementById('recent-cards');
                const cardElement = document.createElement('div');
                cardElement.className = 'card-list-item';
                cardElement.setAttribute('data-id', card.id);
                
                // Handle cloze cards display in recent list
                let frontDisplay = card.front;
                if (card.type === 'cloze') {
                    frontDisplay = card.front.replace(/\{\{([^}]+)\}\}/g, '<span class="cloze">$1</span>');
                }
                
                cardElement.innerHTML = `
                    <div class="card-question">${frontDisplay}</div>
                    <div class="card-answer">${card.back}</div>
                `;
                
                cardElement.addEventListener('click', () => {
                    // Show edit modal for this card
                    editingCardId = card.id;
                    document.getElementById('edit-card-front').value = card.front;
                    document.getElementById('edit-card-back').value = card.back;
                    document.getElementById('edit-card-modal').classList.add('active');
                });
                
                // Add at the beginning (most recent first)
                if (recentCardsList.firstChild) {
                    recentCardsList.insertBefore(cardElement, recentCardsList.firstChild);
                } else {
                    recentCardsList.appendChild(cardElement);
                }
                
                // Keep only the last 10 recent cards
                while (recentCardsList.children.length > 10) {
                    recentCardsList.removeChild(recentCardsList.lastChild);
                }
            }
            
            // Edit card modal
            const editCardModal = document.getElementById('edit-card-modal');
            const closeEditModal = document.getElementById('close-edit-modal');
            const saveEditButton = document.getElementById('save-edit');
            const cancelEditButton = document.getElementById('cancel-edit');
            
            closeEditModal.addEventListener('click', () => {
                editCardModal.classList.remove('active');
            });
            
            cancelEditButton.addEventListener('click', () => {
                editCardModal.classList.remove('active');
            });
            
            // Edit current card button
            document.getElementById('edit-current-card').addEventListener('click', () => {
                if (currentCardIndex < cardsToStudy.length) {
                    const card = cardsToStudy[currentCardIndex];
                    editingCardId = card.id;
                    document.getElementById('edit-card-front').value = card.front;
                    document.getElementById('edit-card-back').value = card.back;
                    document.getElementById('edit-card-modal').classList.add('active');
                }
            });
            
            saveEditButton.addEventListener('click', () => {
                if (editingCardId) {
                    const newFront = document.getElementById('edit-card-front').value.trim();
                    const newBack = document.getElementById('edit-card-back').value.trim();
                    
                    if (!newFront) {
                        showToast('Error', 'Front side cannot be empty', 'error');
                        return;
                    }
                    
                    // Find and update the card
                    for (const deckName in decks) {
                        for (let i = 0; i < decks[deckName].length; i++) {
                            if (decks[deckName][i].id === editingCardId) {
                                decks[deckName][i].front = newFront;
                                decks[deckName][i].back = newBack;
                                saveDecks();
                                
                                showToast('Success', 'Card updated successfully', 'success');
                                editCardModal.classList.remove('active');
                                
                                // Update the card in recent cards list if it exists
                                updateRecentCardDisplay(editingCardId, newFront, newBack);
                                
                                // If studying, update current card display if needed
                                if (currentStudyingDeck && currentCardIndex < cardsToStudy.length) {
                                    const currentCard = cardsToStudy[currentCardIndex];
                                    if (currentCard.id === editingCardId) {
                                        updateCardDisplay(currentCard);
                                    }
                                }
                                
                                return;
                            }
                        }
                    }
                }
            });
            
            function updateRecentCardDisplay(cardId, newFront, newBack) {
                const recentCards = document.querySelectorAll('.card-list-item');
                for (let i = 0; i < recentCards.length; i++) {
                    const card = recentCards[i];
                    if (card.getAttribute('data-id') === cardId) {
                        let frontDisplay = newFront;
                        
                        // Check if it's a cloze card
                        if (newFront.includes('{{') && newFront.includes('}}')) {
                            frontDisplay = newFront.replace(/\{\{([^}]+)\}\}/g, '<span class="cloze">$1</span>');
                        }
                        
                        card.querySelector('.card-question').innerHTML = frontDisplay;
                        card.querySelector('.card-answer').textContent = newBack;
                        break;
                    }
                }
            }
            
            // Reset deck functionality
            const resetDeckModal = document.getElementById('reset-deck-modal');
            const closeResetModal = document.getElementById('close-reset-modal');
            const confirmResetButton = document.getElementById('confirm-reset');
            const cancelResetButton = document.getElementById('cancel-reset');
            
            closeResetModal.addEventListener('click', () => {
                resetDeckModal.classList.remove('active');
            });
            
            cancelResetButton.addEventListener('click', () => {
                resetDeckModal.classList.remove('active');
            });
            
            confirmResetButton.addEventListener('click', () => {
                if (resettingDeckName && decks[resettingDeckName]) {
                    // Reset all cards in the deck
                    decks[resettingDeckName].forEach(card => {
                        card.lastReviewed = null;
                        card.interval = 1;
                        card.ease = 2.5;
                        card.status = 'new';
                    });
                    
                    saveDecks();
                    resetDeckModal.classList.remove('active');
                    renderDeckList();
                    
                    showToast('Success', `Deck "${resettingDeckName}" has been reset`, 'success');
                }
            });
            
            function resetDeck(deckName) {
                resettingDeckName = deckName;
                resetDeckModal.classList.add('active');
            }
            
            // Add economics example deck if it doesn't exist
            if (!decks['Economics 101']) {
                decks['Economics 101'] = [
                    {
                        id: generateId(),
                        front: "What is opportunity cost?",
                        back: "The value of the next best alternative that must be given up in order to pursue a certain action. It represents the benefits you could have received by taking an alternative action.",
                        tags: ["microeconomics", "fundamental"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'basic'
                    },
                    {
                        id: generateId(),
                        front: "Define GDP and explain its components.",
                        back: "Gross Domestic Product (GDP) is the total monetary value of all final goods and services produced within a country's borders in a specific time period.\n\nComponents:\n- Consumption (C): Household spending\n- Investment (I): Business spending on capital\n- Government Spending (G): Public expenditure\n- Net Exports (NX): Exports minus imports",
                        tags: ["macroeconomics", "measurement"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'basic'
                    },
                    {
                        id: generateId(),
                        front: "What are the four factors of production?",
                        back: "1. Land: Natural resources\n2. Labor: Human effort and work\n3. Capital: Human-made tools and infrastructure\n4. Entrepreneurship: Organization, risk-taking, and innovation",
                        tags: ["microeconomics", "fundamental"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'basic'
                    },
                    {
                        id: generateId(),
                        front: "Define elastic and inelastic demand with examples.",
                        back: "Elastic demand: When a small change in price leads to a large change in quantity demanded. Price elasticity > 1. Examples: luxury goods, products with many substitutes.\n\nInelastic demand: When a change in price has little effect on quantity demanded. Price elasticity < 1. Examples: necessities, goods with few substitutes (insulin, gasoline).",
                        tags: ["microeconomics", "elasticity"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'basic'
                    },
                    {
                        id: generateId(),
                        front: "What is the difference between fiscal and monetary policy?",
                        back: "Fiscal Policy: Government's use of taxation and spending to influence the economy. Implemented by legislative and executive branches.\n\nMonetary Policy: Control of money supply and interest rates to influence the economy. Implemented by central banks (e.g., Federal Reserve).",
                        tags: ["macroeconomics", "policy"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'basic'
                    },
                    {
                        id: generateId(),
                        front: "What is the Law of {{Diminishing Marginal Returns}}?",
                        back: "As more units of a variable input are added to fixed inputs, the marginal product of the variable input will eventually decrease. In other words, each additional unit of input yields less additional output than the previous unit.",
                        tags: ["microeconomics", "production"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'cloze'
                    },
                    {
                        id: generateId(),
                        front: "The difference between {{perfect competition}} and {{monopoly}} includes the number of sellers and pricing power.",
                        back: "Perfect Competition:\n- Many small firms\n- Identical products\n- Price takers\n- Free entry/exit\n- Perfect information\n\nMonopoly:\n- Single seller\n- Unique product with no close substitutes\n- Price maker\n- High barriers to entry\n- Profit maximizer (MR = MC)",
                        tags: ["microeconomics", "market structure"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'cloze'
                    },
                    {
                        id: generateId(),
                        front: "The four main causes of inflation are {{demand-pull}}, {{cost-push}}, {{built-in}}, and {{monetary}} inflation.",
                        back: "Main causes of inflation:\n\n1. Demand-Pull: Aggregate demand exceeds aggregate supply\n2. Cost-Push: Rising production costs push prices higher\n3. Built-In: Expectations of future inflation lead to higher wages and prices\n4. Monetary Inflation: Excessive growth in money supply relative to economic output",
                        tags: ["macroeconomics", "inflation"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'cloze'
                    },
                    {
                        id: generateId(),
                        front: "What is the Laffer Curve?",
                        back: "The Laffer Curve illustrates the relationship between tax rates and tax revenue collected by governments. It suggests that there is an optimal tax rate that maximizes revenue, beyond which higher rates actually reduce revenue due to decreased economic activity or increased tax avoidance.",
                        tags: ["macroeconomics", "taxation"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'basic'
                    },
                    {
                        id: generateId(),
                        front: "Define {{comparative advantage}} and {{absolute advantage}}.",
                        back: "Absolute Advantage: When a country or individual can produce more of a good with the same resources than another.\n\nComparative Advantage: When a country or individual can produce a good at a lower opportunity cost than another, even if they don't have an absolute advantage.",
                        tags: ["international", "trade"],
                        lastReviewed: null,
                        interval: 1,
                        ease: 2.5,
                        status: 'new',
                        type: 'cloze'
                    }
                ];
                saveDecks();
            }
            
            // Render deck list
            function renderDeckList() {
                const deckList = document.getElementById('deck-list');
                const noDecks = document.getElementById('no-decks');
                deckList.innerHTML = '';
                
                const deckNames = Object.keys(decks);
                
                if (deckNames.length === 0) {
                    deckList.style.display = 'none';
                    noDecks.style.display = 'block';
                } else {
                    deckList.style.display = 'grid';
                    noDecks.style.display = 'none';
                    
                    // Color array for deck color tags
                    const colors = [
                        '#007AFF', // Blue
                        '#34C759', // Green
                        '#FF9500', // Orange
                        '#FF2D55', // Red
                        '#AF52DE', // Purple
                        '#5AC8FA', // Light Blue
                        '#FF3B30', // Red
                        '#FFCC00'  // Yellow
                    ];
                    
                    deckNames.forEach((deckName, index) => {
                        const deckCards = decks[deckName];
                        const dueCount = getDueCardsCount(deckName);
                        
                        // Get all unique tags in the deck
                        const deckTags = new Set();
                        deckCards.forEach(card => {
                            if (card.tags) {
                                card.tags.forEach(tag => deckTags.add(tag));
                            }
                        });
                        
                        // Get color based on index
                        const colorIndex = index % colors.length;
                        const deckColor = colors[colorIndex];
                        
                        const deckElement = document.createElement('div');
                        deckElement.className = 'deck-card';
                        deckElement.innerHTML = `
                            <div class="deck-color-tag" style="background-color: ${deckColor};"></div>
                            <div class="deck-header">
                                <h3 class="deck-title">${deckName}</h3>
                                <div>${getLastStudiedDate(deckName)}</div>
                            </div>
                            <div class="deck-stats">
                                <div class="stat">
                                    <i class="fas fa-clone"></i>
                                    <span>${deckCards.length} cards</span>
                                </div>
                                <div class="stat">
                                    <i class="fas fa-hourglass-half"></i>
                                    <span>${dueCount} due</span>
                                </div>
                            </div>
                            <div class="tag-list">
                                ${Array.from(deckTags).slice(0, 3).map(tag => `<div class="tag">${tag}</div>`).join('')}
                                ${deckTags.size > 3 ? `<div class="tag">+${deckTags.size - 3}</div>` : ''}
                            </div>
                            <div class="deck-actions">
                                <button class="study-deck-btn">
                                    <i class="fas fa-book-open"></i> Study
                                </button>
                                <div>
                                    <button class="action-btn reset-deck-btn" title="Reset Progress">
                                        <i class="fas fa-redo-alt"></i>
                                    </button>
                                    <button class="action-btn delete-deck-btn" title="Delete Deck">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        deckList.appendChild(deckElement);
                    });
                }
            }
            
            document.getElementById('create-first-deck').addEventListener('click', () => {
                document.querySelector('[data-tab="create"]').click();
            });
            
            document.getElementById('show-deck-list').addEventListener('click', () => {
                document.querySelector('[data-tab="decks"]').click();
            });
            
            // Filter dropdown
            document.getElementById('filter-btn').addEventListener('click', () => {
                document.getElementById('filter-menu').classList.toggle('active');
            });
            
            document.addEventListener('click', (e) => {
                const filterMenu = document.getElementById('filter-menu');
                const filterBtn = document.getElementById('filter-btn');
                
                if (filterMenu.classList.contains('active') && 
                    !filterMenu.contains(e.target) && 
                    e.target !== filterBtn) {
                    filterMenu.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.filter-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    document.getElementById('filter-menu').classList.remove('active');
                    // Would implement actual filtering here
                });
            });
            
            // Deck search
            document.getElementById('deck-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                
                document.querySelectorAll('.deck-card').forEach(deck => {
                    const deckName = deck.querySelector('.deck-title').textContent.toLowerCase();
                    const tags = Array.from(deck.querySelectorAll('.tag')).map(tag => tag.textContent.toLowerCase());
                    
                    if (deckName.includes(searchTerm) || tags.some(tag => tag.includes(searchTerm))) {
                        deck.style.display = '';
                    } else {
                        deck.style.display = 'none';
                    }
                });
            });
            
            // Study session
            function startStudySession(deckName) {
                if (!decks[deckName] || decks[deckName].length === 0) {
                    showToast('Error', `No cards in deck "${deckName}"`, 'error');
                    return;
                }
                
                currentStudyingDeck = deckName;
                document.getElementById('study-deck-name').textContent = deckName;
                
                // Get due cards using the SM-2 algorithm
                cardsToStudy = getDueCards(deckName);
                
                // Update study UI
                document.getElementById('total-count').textContent = cardsToStudy.length;
                document.getElementById('remaining-count').textContent = cardsToStudy.length;
                document.getElementById('study-progress').style.width = '0%';
                
                if (cardsToStudy.length > 0) {
                    document.getElementById('study-card-container').style.display = 'block';
                    document.getElementById('deck-selection').style.display = 'none';
                    document.getElementById('session-complete').style.display = 'none';
                    
                    // Shuffle cards
                    cardsToStudy = shuffleArray(cardsToStudy);
                    currentCardIndex = 0;
                    
                    // Start session timer
                    studySessionStartTime = new Date();
                    if (sessionTimer) clearInterval(sessionTimer);
                    sessionTimer = setInterval(updateSessionTime, 1000);
                    
                    // Show the first card
                    showCurrentCard();
                    
                    // Update statistics
                    updateStudyStreak();
                } else {
                    document.getElementById('study-card-container').style.display = 'none';
                    document.getElementById('deck-selection').style.display = 'none';
                    document.getElementById('session-complete').style.display = 'block';
                    document.getElementById('session-summary').textContent = `All cards in "${deckName}" are up to date.`;
                }
            }
            
            function updateSessionTime() {
                if (!studySessionStartTime) return;
                
                const now = new Date();
                const elapsedMs = now - studySessionStartTime;
                const minutes = Math.floor(elapsedMs / 60000);
                const seconds = Math.floor((elapsedMs % 60000) / 1000);
                
                document.getElementById('session-time').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            function getDueCards(deckName) {
                const now = new Date();
                
                return decks[deckName].filter(card => {
                    // If never reviewed, it's due
                    if (!card.lastReviewed) return true;
                    
                    // Otherwise check if it's due based on interval
                    const lastReviewed = new Date(card.lastReviewed);
                    const dueDate = new Date(lastReviewed);
                    dueDate.setDate(dueDate.getDate() + card.interval);
                    
                    return now >= dueDate;
                });
            }
            
            function getDueCardsCount(deckName) {
                if (!decks[deckName]) return 0;
                
                const now = new Date();
                return decks[deckName].filter(card => {
                    if (!card.lastReviewed) return true;
                    
                    const lastReviewed = new Date(card.lastReviewed);
                    const dueDate = new Date(lastReviewed);
                    dueDate.setDate(dueDate.getDate() + card.interval);
                    
                    return now >= dueDate;
                }).length;
            }
            
            function getLastStudiedDate(deckName) {
                if (!decks[deckName]) return 'Never studied';
                
                const lastReviewedDates = decks[deckName]
                    .filter(card => card.lastReviewed)
                    .map(card => new Date(card.lastReviewed));
                
                if (lastReviewedDates.length === 0) return 'Never studied';
                
                const mostRecent = new Date(Math.max(...lastReviewedDates));
                const now = new Date();
                const diffDays = Math.floor((now - mostRecent) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Studied today';
                if (diffDays === 1) return 'Studied yesterday';
                return `Studied ${diffDays} days ago`;
            }
            
            function showCurrentCard() {
                if (cardsToStudy.length === 0 || currentCardIndex >= cardsToStudy.length) {
                    completeStudySession();
                    return;
                }
                
                const card = cardsToStudy[currentCardIndex];
                
                // Reset card flip
                document.getElementById('flashcard').classList.remove('flipped');
                
                // Update card display
                updateCardDisplay(card);
                
                // Update card number
                document.getElementById('card-number').textContent = `Card ${currentCardIndex + 1}/${cardsToStudy.length}`;
                
                // Show flip controls, hide rating controls
                document.getElementById('flip-controls').style.display = 'flex';
                document.getElementById('rating-controls').style.display = 'none';
                
                // Update remaining count and progress bar
                document.getElementById('remaining-count').textContent = cardsToStudy.length - currentCardIndex;
                const progressPercentage = ((currentCardIndex) / cardsToStudy.length) * 100;
                document.getElementById('study-progress').style.width = `${progressPercentage}%`;
            }
            
            function updateCardDisplay(card) {
                // Update card content
                const frontContent = document.getElementById('card-front-content');
                const backContent = document.getElementById('card-back-content');
                
                // Handle cloze cards differently
                if (card.type === 'cloze') {
                    // For front side, replace cloze with [...]
                    frontContent.innerHTML = card.front.replace(/\{\{([^}]+)\}\}/g, '<span class="cloze">[...]</span>');
                    
                    // For back side, highlight the cloze content
                    backContent.innerHTML = card.front.replace(/\{\{([^}]+)\}\}/g, '<span class="cloze-revealed">$1</span>') + 
                        (card.back ? `<hr style="margin: 1rem 0"><div>${card.back}</div>` : '');
                } else {
                    // Basic cards
                    frontContent.textContent = card.front;
                    backContent.textContent = card.back;
                }
            }
            
            // Flip card
            document.getElementById('flip-card').addEventListener('click', flipCard);
            
            function flipCard() {
                const flashcard = document.getElementById('flashcard');
                flashcard.classList.toggle('flipped');
                
                // Show rating controls after flip
                if (flashcard.classList.contains('flipped')) {
                    document.getElementById('flip-controls').style.display = 'none';
                    document.getElementById('rating-controls').style.display = 'flex';
                } else {
                    document.getElementById('flip-controls').style.display = 'flex';
                    document.getElementById('rating-controls').style.display = 'none';
                }
            }
            
            // Card rating
            document.querySelectorAll('#rating-controls button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const difficulty = e.target.closest('button').getAttribute('data-difficulty');
                    processCardRating(difficulty);
                });
            });
            
            // Session completion
            function completeStudySession() {
                // Stop the timer
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }
                
                // Update UI
                document.getElementById('study-card-container').style.display = 'none';
                document.getElementById('deck-selection').style.display = 'none';
                document.getElementById('session-complete').style.display = 'block';
                
                // Calculate session stats
                const sessionDuration = new Date() - studySessionStartTime;
                const minutes = Math.floor(sessionDuration / 60000);
                const seconds = Math.floor((sessionDuration % 60000) / 1000);
                const timeStr = `${minutes}m ${seconds}s`;
                
                document.getElementById('session-summary').innerHTML = `
                    <div>Session Time: ${timeStr}</div>
                    <div>Cards Reviewed: ${cardsToStudy.length}</div>
                `;
                
                // Update total cards studied count
                statistics.totalStudied += cardsToStudy.length;
                saveStatistics();
            }
            
            document.getElementById('restart-session').addEventListener('click', () => {
                if (currentStudyingDeck) {
                    startStudySession(currentStudyingDeck);
                }
            });
            
            document.getElementById('return-to-decks').addEventListener('click', () => {
                document.querySelector('[data-tab="decks"]').click();
            });
            
            // Process card rating and apply spaced repetition algorithm
            function processCardRating(difficulty) {
                if (currentCardIndex >= cardsToStudy.length) return;
                
                const card = cardsToStudy[currentCardIndex];
                const originalCard = findOriginalCard(card);
                
                if (!originalCard) return;
                
                // Update last reviewed time
                originalCard.lastReviewed = new Date().toISOString();
                
                // Apply SM-2 algorithm
                switch (difficulty) {
                    case 'again':
                        originalCard.interval = 1;
                        originalCard.ease = Math.max(1.3, originalCard.ease - 0.2);
                        break;
                    case 'hard':
                        originalCard.interval = Math.max(1, Math.ceil(originalCard.interval * 1.2));
                        originalCard.ease = Math.max(1.3, originalCard.ease - 0.15);
                        break;
                    case 'good':
                        originalCard.interval = Math.ceil(originalCard.interval * originalCard.ease);
                        break;
                    case 'easy':
                        originalCard.interval = Math.ceil(originalCard.interval * originalCard.ease * 1.3);
                        originalCard.ease = Math.min(2.5, originalCard.ease + 0.15);
                        
                        // Count as mastered if interval is large enough
                        if (originalCard.interval > 30 && originalCard.status !== 'mastered') {
                            originalCard.status = 'mastered';
                            statistics.cardsMastered++;
                            saveStatistics();
                        }
                        break;
                }
                
                // Update card status if not mastered
                if (originalCard.status !== 'mastered') {
                    originalCard.status = 'learning';
                }
                
                // Save changes
                saveDecks();
                
                // Move to next card
                currentCardIndex++;
                showCurrentCard();
                
                // Update daily statistics
                const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                if (!statistics.dailyStats[today]) {
                    statistics.dailyStats[today] = { studied: 0, mastered: 0 };
                }
                statistics.dailyStats[today].studied++;
                saveStatistics();
            }
            
            // Find the original card in the deck
            function findOriginalCard(card) {
                if (!currentStudyingDeck || !card.id) return null;
                
                for (let i = 0; i < decks[currentStudyingDeck].length; i++) {
                    if (decks[currentStudyingDeck][i].id === card.id) {
                        return decks[currentStudyingDeck][i];
                    }
                }
                
                return null;
            }
            
            // Update statistics
            function updateStatistics() {
                // Count total cards and decks
                let totalCards = 0;
                for (const deckName in decks) {
                    totalCards += decks[deckName].length;
                }
                
                document.getElementById('total-cards-stat').textContent = totalCards;
                document.getElementById('total-decks-stat').textContent = Object.keys(decks).length;
                document.getElementById('cards-studied-stat').textContent = getCardsStudiedToday();
                document.getElementById('streak-stat').textContent = statistics.streak || 0;
                
                // Update forecast data in the UI
                updateForecast();
            }
            
            function updateForecast() {
                const forecastData = [];
                let totalDue = 0;
                const now = new Date();
                
                for (let day = 0; day < 7; day++) {
                    const d = new Date();
                    d.setDate(now.getDate() + day);
                    const dateStr = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    
                    // Count cards due for each day
                    let dueThatDay = 0;
                    for (const deckName in decks) {
                        decks[deckName].forEach(card => {
                            if (card.lastReviewed) {
                                const lastReviewed = new Date(card.lastReviewed);
                                const dueDate = new Date(lastReviewed);
                                dueDate.setDate(dueDate.getDate() + card.interval);
                                
                                // Check if due on this specific day
                                if (dueDate.toISOString().slice(0, 10) === d.toISOString().slice(0, 10)) {
                                    dueThatDay++;
                                }
                            } else if (day === 0) {
                                // New cards are due today
                                dueThatDay++;
                            }
                        });
                    }
                    
                    totalDue += dueThatDay;
                    forecastData.push({
                        date: dateStr,
                        due: dueThatDay
                    });
                }
                
                // Update the forecast in the UI
                const forecastContainer = document.getElementById('forecast-container');
                forecastContainer.innerHTML = `
                    <div style="padding: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <div style="font-weight: 600;">Next 7 Days</div>
                            <div style="color: var(--primary-color); font-weight: 600;">${totalDue} cards due</div>
                        </div>
                        ${forecastData.map(day => `
                            <div class="forecast-day">
                                <div class="forecast-date">${day.date}</div>
                                <div class="forecast-count">${day.due}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            function updateStudyStreak() {
                const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                
                if (!statistics.lastStudyDate || statistics.lastStudyDate !== today) {
                    // Check if the last study was yesterday
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().slice(0, 10);
                    
                    if (statistics.lastStudyDate === yesterdayStr) {
                        // Increment streak if last study was yesterday
                        statistics.streak = (statistics.streak || 0) + 1;
                    } else if (!statistics.lastStudyDate || statistics.lastStudyDate !== today) {
                        // Reset streak if not consecutive
                        statistics.streak = 1;
                    }
                    
                    statistics.lastStudyDate = today;
                    saveStatistics();
                }
            }
            
            function getCardsStudiedToday() {
                const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                
                let count = 0;
                for (const deckName in decks) {
                    decks[deckName].forEach(card => {
                        if (card.lastReviewed && card.lastReviewed.startsWith(today)) {
                            count++;
                        }
                    });
                }
                
                return count;
            }
            
            // Import/Export functions
            document.getElementById('export-deck').addEventListener('click', () => {
                const deckName = document.getElementById('deck-name').value.trim() || 'Default Deck';
                
                if (!decks[deckName] || decks[deckName].length === 0) {
                    showToast('Error', `No cards in "${deckName}" to export`, 'error');
                    return;
                }
                
                const exportData = {
                    name: deckName,
                    cards: decks[deckName],
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportName = `${deckName.replace(/\s+/g, '_')}_flashcards.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportName);
                linkElement.click();
                
                showToast('Success', `Exported deck "${deckName}" successfully`, 'success');
            });
            
            document.getElementById('import-deck').addEventListener('click', () => {
                document.getElementById('import-file').click();
            });
            
            document.getElementById('import-file').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.name || !Array.isArray(importedData.cards)) {
                            showToast('Error', 'Invalid file format', 'error');
                            return;
                        }
                        
                        const deckName = importedData.name;
                        
                        // Check if deck already exists
                        if (decks[deckName] && !confirm(`Deck "${deckName}" already exists. Merge with existing deck?`)) {
                            return;
                        }
                        
                        // Create or update deck
                        if (!decks[deckName]) {
                            decks[deckName] = [];
                        }
                        
                        // Add cards, ensuring they have IDs
                        importedData.cards.forEach(card => {
                            if (!card.id) {
                                card.id = generateId();
                            }
                            // Ensure card has all needed properties
                            if (!card.type) card.type = 'basic';
                            if (!card.tags) card.tags = [];
                            if (!card.interval) card.interval = 1;
                            if (!card.ease) card.ease = 2.5;
                            if (!card.status) card.status = 'new';
                            
                            decks[deckName].push(card);
                        });
                        
                        // Save and update UI
                        saveDecks();
                        renderDeckList();
                        
                        showToast('Success', `Imported ${importedData.cards.length} cards to "${deckName}"`, 'success');
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Error', 'Could not parse file. Make sure it is a valid JSON file.', 'error');
                    }
                };
                
                reader.readAsText(file);
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Only process if we're in study mode
                if (!document.getElementById('study').classList.contains('active') || 
                    document.getElementById('study-card-container').style.display === 'none') {
                    return;
                }
                
                switch (e.key) {
                    case ' ': // Space bar for flipping
                        e.preventDefault();
                        flipCard();
                        break;
                    case '1': // Again
                        if (document.getElementById('flashcard').classList.contains('flipped')) {
                            processCardRating('again');
                        }
                        break;
                    case '2': // Hard
                        if (document.getElementById('flashcard').classList.contains('flipped')) {
                            processCardRating('hard');
                        }
                        break;
                    case '3': // Good
                        if (document.getElementById('flashcard').classList.contains('flipped')) {
                            processCardRating('good');
                        }
                        break;
                    case '4': // Easy
                        if (document.getElementById('flashcard').classList.contains('flipped')) {
                            processCardRating('easy');
                        }
                        break;
                    case 'e': // Edit current card
                    case 'E':
                        if (currentCardIndex < cardsToStudy.length) {
                            const card = cardsToStudy[currentCardIndex];
                            editingCardId = card.id;
                            document.getElementById('edit-card-front').value = card.front;
                            document.getElementById('edit-card-back').value = card.back;
                            document.getElementById('edit-card-modal').classList.add('active');
                        }
                        break;
                }
            });
            
            // Toast notification
            function showToast(title, message, type = 'success') {
                const toast = document.getElementById('toast');
                const toastTitle = toast.querySelector('.toast-title');
                const toastMessage = toast.querySelector('.toast-message');
                const toastIcon = toast.querySelector('.toast-icon i');
                
                // Set content
                toastTitle.textContent = title;
                toastMessage.textContent = message;
                
                // Set icon and class based on type
                switch (type) {
                    case 'success':
                        toastIcon.className = 'fas fa-check-circle';
                        toast.className = 'toast success';
                        break;
                    case 'error':
                        toastIcon.className = 'fas fa-exclamation-circle';
                        toast.className = 'toast error';
                        break;
                    case 'info':
                        toastIcon.className = 'fas fa-info-circle';
                        toast.className = 'toast info';
                        break;
                }
                
                // Show the toast
                toast.classList.add('active');
                
                // Hide after 3 seconds
                setTimeout(() => {
                    toast.classList.remove('active');
                }, 3000);
            }
            
            document.getElementById('toast').querySelector('.toast-close').addEventListener('click', () => {
                document.getElementById('toast').classList.remove('active');
            });
            
            // Helper functions
            function saveDecks() {
                localStorage.setItem('flashcards-decks', JSON.stringify(decks));
            }
            
            function saveStatistics() {
                localStorage.setItem('flashcards-stats', JSON.stringify(statistics));
            }
            
            function generateId() {
                return Math.random().toString(36).substring(2, 15) + 
                       Math.random().toString(36).substring(2, 15);
            }
            
            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            
            // Initialize UI
            renderDeckList();
            updateStatistics();
        });
    </script>
</body>
</html>
